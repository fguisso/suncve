<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>SUNCVE - Rastreando CVEs, commits e PoCs na bala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <!-- Fonte tech -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Share Tech Mono', monospace;
      background-image: url('/assets/imgs/cubes.png');
      background-color: #0d0d0d;
    }

    .toggle-btn {
      padding: 0.4rem 0.75rem;
      border-radius: 9999px;
      border: 1px solid #3a3a3a;
      background-color: #2a2a2a;
      font-size: 0.875rem;
      color: #f0eada;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background-color: #f0eada;
      color: #1c1c1c;
      border-color: #f0eada;
    }
  </style>
</head>

<body class="text-[#f0eada] min-h-screen flex flex-col items-center px-4">

  <!-- Cabe√ßalho com logo -->
  <header class="w-full max-w-6xl py-8 flex flex-col items-center text-center">
    <img src="/assets/imgs/sunsec.png" alt="Logo Sunsec" class="w-24 h-24 mb-4 rounded-full" />
    <h1 class="text-4xl font-bold tracking-wider">SUNCVE</h1>
    <p class="text-sm text-[#c4bfb5] mt-1">Rastreando CVEs, commits e PoCs na bala.</p>
  </header>

  <!-- Busca + Bot√£o Filtro + Dropdown -->
  <div class="w-full max-w-4xl flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
    <input type="text" id="busca" placeholder="Digite parte da descri√ß√£o..."
      class="w-full sm:w-2/3 px-4 py-2 rounded-md bg-[#1c1c1c] text-[#f0eada] border border-[#3a3a3a] focus:outline-none focus:ring-2 focus:ring-[#f0eada]" />

    <!-- Dropdown -->
    <div class="relative">
      <button onclick="toogleOptionSearch()" id="dropdownBtn"
        class="px-4 py-2 rounded-md bg-[#1c1c1c] text-[#f0eada] border border-[#3a3a3a] hover:bg-[#2c2c2c] flex items-center gap-2">
         <span id="dropdownValue">CVEs</span>
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <ul id="dropdownMenu"
        class="absolute mt-2 right-0 w-36 bg-[#1c1c1c] border border-[#3a3a3a] rounded-md shadow-md text-sm text-[#f0eada] hidden z-50">
        <li><button onclick="selectOptionSearch('CVEs')"
            class="w-full text-left px-4 py-2 hover:bg-[#2c2c2c]">CVEs</button></li>
        <li><button onclick="selectOptionSearch('Reposit√≥rios')"
            class="w-full text-left px-4 py-2 hover:bg-[#2c2c2c]">Reposit√≥rios</button></li>
      </ul>
    </div>

    <button onclick="toggleModal()"
      class="px-4 py-2 rounded-md bg-[#f0eada] text-black font-semibold hover:bg-[#e0d9c9] transition">
      Filtros
    </button>
  </div>

  <!-- Resultados -->
  <div id="resultado">
    <div class="col-span-full text-center text-sm text-[#c4bfb5]">Carregando base de dados...</div>
  </div>

  <!-- Modal de Filtros -->
  <div id="filterModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4 sm:p-0">
    <div class="bg-[#1c1c1c] w-full max-w-md p-6 rounded-lg shadow-lg text-[#f0eada] relative">
      <button onclick="toggleModal()" class="absolute top-2 right-3 text-[#f0eada] text-2xl font-bold">&times;</button>
      <h2 class="text-2xl font-semibold mb-4">Filtros</h2>

      <!-- Filtros CVEs -->
      <div id="filtros-cves" class="space-y-4">
        <div>
          <p class="text-sm text-[#c4bfb5] mb-2">CWEs por categoria:</p>

          <!-- üîì Acesso indevido -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-[#a1a1aa] mb-1">Acesso Indevido</p>
            <div class="flex flex-wrap gap-2">
              <button class="toggle-btn" data-group="cwe">CWE-639</button> <!-- IDOR -->
              <button class="toggle-btn" data-group="cwe">CWE-285</button> <!-- Improper Authorization -->
              <button class="toggle-btn" data-group="cwe">CWE-284</button> <!-- Improper Access Control -->
              <button class="toggle-btn" data-group="cwe">CWE-287</button> <!-- Improper Authentication -->
            </div>
          </div>

          <!-- üß™ Inje√ß√µes -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-[#a1a1aa] mb-1">Inje√ß√µes</p>
            <div class="flex flex-wrap gap-2">
              <button class="toggle-btn" data-group="cwe">CWE-79</button> <!-- XSS -->
              <button class="toggle-btn" data-group="cwe">CWE-89</button> <!-- SQL Injection -->
              <button class="toggle-btn" data-group="cwe">CWE-77</button> <!-- Command Injection -->
              <button class="toggle-btn" data-group="cwe">CWE-74</button> <!-- XSS Alternate -->
            </div>
          </div>

          <!-- üìÇ File / Path -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-[#a1a1aa] mb-1">LFI, Path Traversal & File Access</p>
            <div class="flex flex-wrap gap-2">
              <button class="toggle-btn" data-group="cwe">CWE-22</button> <!-- Path Traversal -->
              <button class="toggle-btn" data-group="cwe">CWE-23</button> <!-- Relative Path Traversal -->
              <button class="toggle-btn" data-group="cwe">CWE-36</button> <!-- Absolute Path Traversal -->
              <button class="toggle-btn" data-group="cwe">CWE-73</button> <!-- External Control of File Name -->
              <button class="toggle-btn" data-group="cwe">CWE-552</button>
              <!-- Files or Directories Exposed to Wrong Party -->
            </div>
          </div>

          <!-- üîê Autentica√ß√£o & Sess√£o -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-[#a1a1aa] mb-1">Sess√£o e Autentica√ß√£o</p>
            <div class="flex flex-wrap gap-2">
              <button class="toggle-btn" data-group="cwe">CWE-798</button> <!-- Hardcoded Credentials -->
              <button class="toggle-btn" data-group="cwe">CWE-311</button> <!-- Missing Encryption -->
              <button class="toggle-btn" data-group="cwe">CWE-614</button> <!-- Sensitive Data in GET -->
            </div>
          </div>

          <!-- üß± Outras cr√≠ticas -->
          <div class="mb-4">
            <p class="text-xs font-semibold text-[#a1a1aa] mb-1">Outras Comuns</p>
            <div class="flex flex-wrap gap-2">
              <button class="toggle-btn" data-group="cwe">CWE-119</button> <!-- Buffer Overflow -->
              <button class="toggle-btn" data-group="cwe">CWE-20</button> <!-- Input Validation -->
              <button class="toggle-btn" data-group="cwe">CWE-200</button> <!-- Information Exposure -->
              <button class="toggle-btn" data-group="cwe">CWE-352</button> <!-- CSRF -->
            </div>
          </div>
        </div>

        <hr/>
        <div>
          <p class="text-sm text-[#c4bfb5] mb-2">CVSS Score:</p>
          <div class="flex flex-wrap gap-2">
            <button class="toggle-btn" data-group="score">Low</button>
            <button class="toggle-btn" data-group="score">Medium</button>
            <button class="toggle-btn" data-group="score">High</button>
            <button class="toggle-btn" data-group="score">Critic</button>
          </div>
        </div>

        <div>
          <p class="text-sm text-[#c4bfb5] mb-2">Options:</p>
          <div class="flex flex-wrap gap-2">
            <button class="toggle-btn" data-group="options">Repositorie</button>
            <button class="toggle-btn" data-group="options">Advisorie</button>
            <button class="toggle-btn" data-group="options">POC</button>
            <button class="toggle-btn" data-group="options">Commit</button>
          </div>
        </div>

        <div>
          <p class="text-sm text-[#c4bfb5] mb-2">CVE Language Main:</p>
          <div class="flex flex-wrap gap-2">
            <button class="toggle-btn" data-group="cve_lang_main">JavaScript</button>
            <button class="toggle-btn" data-group="cve_lang_main">Python</button>
            <button class="toggle-btn" data-group="cve_lang_main">Ruby</button>
            <button class="toggle-btn" data-group="cve_lang_main">PHP</button>
          </div>
        </div>

      </div>

      <!-- Filtros Reposit√≥rios -->
      <div id="filtros-repos" class="space-y-4 hidden">
        <p class="text-sm text-[#c4bfb5] mb-2">Linguagens:</p>
        <div class="flex flex-wrap gap-2">
          <button class="toggle-btn" data-group="lang">JavaScript</button>
          <button class="toggle-btn" data-group="lang">Python</button>
          <button class="toggle-btn" data-group="lang">Ruby</button>
          <button class="toggle-btn" data-group="lang">PHP</button>
        </div>
      </div>

      <div class="mt-6 text-right">
        <button onclick="toggleModal()" class="px-4 py-2 bg-[#f0eada] text-black rounded hover:bg-[#e0d9c9]">
          Aplicar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    let optionSearch = "CVEs";
    let dadosJSON = {};
    let cweMap = {};
    let scoreMap = {};
    let CVEsPocList = []
    let repositoriesJSON = {}
    let repositoriesCVEsJSON = {}
    let cvesPocListInGithub = []
    let cvesPocAdvisories = []

    const MAX_RESULTADOS = 20;
    const resultadoContainer = document.getElementById("resultado");

    function getFiltrosSelecionados(grupo) {
      const botoes = document.querySelectorAll(`.toggle-btn[data-group="${grupo}"].active`);
      return Array.from(botoes).map(btn => btn.textContent.trim());
    }

    function toogleOptionSearch() {
      document.getElementById("dropdownMenu").classList.toggle("hidden");
    }

    function selectOptionSearch(value) {
      document.getElementById("dropdownValue").textContent = value;
      document.getElementById("dropdownMenu").classList.add("hidden");
      optionSearch = value;

      // Alterna filtros
      document.getElementById("filtros-cves").classList.toggle("hidden", value !== "CVEs");
      document.getElementById("filtros-repos").classList.toggle("hidden", value !== "Reposit√≥rios");

      resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-[#c4bfb5]">Base carregada. Agora busque algo.</div>`;

      if (optionSearch === "CVEs") {
        buscarDescricoes(document.getElementById("busca").value, { cwe: getFiltrosSelecionados("cwe"), score: getFiltrosSelecionados("score"), options: getFiltrosSelecionados("options"), langMain: getFiltrosSelecionados("cve_lang_main") });
      } else {
        buscarRepositories(document.getElementById("busca").value, { lang: getFiltrosSelecionados("lang") });
      }
    }

    function toggleModal() {
      const modal = document.getElementById('filterModal');
      modal.classList.toggle('hidden');
      modal.classList.toggle('flex');
    }

    // Ativar/desativar bot√µes toggle
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("toggle-btn")) {
        e.target.classList.toggle("active");
        if (optionSearch === "CVEs") {
          buscarDescricoes(document.getElementById("busca").value, { cwe: getFiltrosSelecionados("cwe"), score: getFiltrosSelecionados("score"), options: getFiltrosSelecionados("options"), langMain: getFiltrosSelecionados("cve_lang_main") });
        }
        if (optionSearch == "Reposit√≥rios") {
          buscarRepositories(document.getElementById("busca").value, { lang: getFiltrosSelecionados("lang") });
        }
      }
    });

    async function carregarJsonComprimido(url) {
      const response = await fetch(url);
      const compressed = new Uint8Array(await response.arrayBuffer());
      const decompressed = pako.ungzip(compressed, { to: 'string' });
      dadosJSON = JSON.parse(decompressed);
      resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-[#c4bfb5]">Base carregada. Agora busque algo.</div>`;
    }

    async function carregarCWEMap() {
      try {
        const response = await fetch("/index/cwes.json");
        if (!response.ok) throw new Error("Falha ao carregar cwes.json");
        cweMap = await response.json();
      } catch (e) {
        console.error("Erro ao carregar cwes.json:", e);
        cweMap = {};
      }
    }

    async function carregarScoreMap() {
      try {
        const response = await fetch("/index/score.json");
        if (!response.ok) throw new Error("Falha ao carregar cwes.json");
        scoreMap = await response.json();
      } catch (e) {
        console.error("Erro ao carregar cwes.json:", e);
        scoreMap = {};
      }
    }

    async function getInfoCVE(cveID) {
      try {
        const response = await fetch(`/cves/${cveID}.json`);
        if (!response.ok) return {};
        const data = await response.json();
        return data;
      } catch (erro) {
        return {};
      }
    }

    async function getRepositories() {
      try {
        var response = await fetch("/index/repositories.json");
        if (!response.ok) return {};
        repositoriesJSON = await response.json();

        response = await fetch("/index/cves_repositories.json");
        if (!response.ok) return {};
        repositoriesCVEsJSON = await response.json();

        response = await fetch("/index/cves_poc_advisories.json");
        if (!response.ok) return {};
        cvesPocAdvisories = await response.json();

        response = await fetch("/index/cves_poc_list_in_github.json");
        if (!response.ok) return {};
        cvesPocListInGithub = await response.json();

      } catch (erro) {
        return {};
      }
    }

    function formatNumbers(num) {
      if (num < 1000) return num.toString();

      if (num < 1_000_000) {
        return (num / 1000).toFixed(1).replace('.0', '') + 'k';
      }

      return (num / 1_000_000).toFixed(1).replace('.0', '') + 'M';
    }

    async function buscarDescricoes(texto, filter = { cwe: [], score: [], options: [], langMain: [] }) {
      resultadoContainer.className = "w-full max-w-4xl grid grid-cols-1 gap-6 mb-10";
      resultadoContainer.innerHTML = "";
      //if (!texto.trim()) {
      //  resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-[#c4bfb5]">Digite algo para buscar.</div>`;
      //  return;
      //}

      const cvesPermitidosPorCWE = new Set();
      const cvesPermitidosPorScore = new Set();
      const cvesPermitidosLangMain = new Set();
      var cvesPermitidosPorOptions = new Set();

      // Coleta os CVEs permitidos a partir das CWEs selecionadas
      if (filter.cwe.length > 0) {
        filter.cwe.forEach(cwe => {
          const relacionados = cweMap[cwe] || [];
          relacionados.forEach(cve => cvesPermitidosPorCWE.add(cve));
        });
      }

      if (filter.score.length > 0) {
        filter.score.forEach(sc => {
          const relacionados = scoreMap[sc] || [];
          relacionados.forEach(cve => cvesPermitidosPorScore.add(cve));
        });
      }

      if (filter.options.length > 0) {
        const conjuntosPorFiltro = [];

        filter.options.forEach(opt => {
          const set = new Set();

          if (opt === "Repositorie") {
            Object.values(repositoriesCVEsJSON).forEach(repo => {
              repo.listCVEs?.forEach(cve => set.add(cve));
            });
          }

          if (opt === "Commit") {
            Object.values(repositoriesCVEsJSON).forEach(repo => {
              repo.commitsCVEs?.forEach(cve => set.add(cve));
            });
          }

          if (opt === "Advisorie") {
            cvesPocAdvisories.forEach(cve => set.add(cve));
          }

          if (opt === "POC") {
            cvesPocAdvisories.forEach(cve => set.add(cve));
            cvesPocListInGithub.forEach(cve => set.add(cve));
          }

          conjuntosPorFiltro.push(set);
        });

        // Faz interse√ß√£o entre os filtros
        if (conjuntosPorFiltro.length > 0) {
          cvesPermitidosPorOptions = new Set(
            [...conjuntosPorFiltro[0]].filter(cve =>
              conjuntosPorFiltro.every(set => set.has(cve))
            )
          );
        }
      }

      const encontrados = Object.entries(dadosJSON).filter(([chave, _]) =>
        chave.toLowerCase().includes(texto.toLowerCase())
      );

      let resultadosRenderizados = 0;

      for (const [chave, valor] of encontrados) {
        for (const v of valor) {
          if (filter.cwe.length > 0 && !cvesPermitidosPorCWE.has(v)) continue;  // esse CVE n√£o est√° vinculado ao filtro CWE
          if (filter.score.length > 0 && !cvesPermitidosPorScore.has(v)) continue;  // esse CVE n√£o est√° vinculado ao filtro Score
          if (filter.options.length > 0 && !cvesPermitidosPorOptions.has(v)) continue;  // esse CVE n√£o est√° vinculado as op√ß√µes

          const infoCVE = await getInfoCVE(v);
          const cvssScore = parseFloat(infoCVE.cvss?.[0]?.baseScore || 0);
          const cwe = infoCVE.cwe || "";

          if (resultadosRenderizados >= MAX_RESULTADOS) break;

          // Define cores
          let cvssColor = "#a8a29e", borderColor = "#3f3f46";
          if (cvssScore >= 9.0) { cvssColor = "#ef4444"; borderColor = "#ef4444"; }
          else if (cvssScore >= 7.0) { cvssColor = "#f97316"; borderColor = "#f97316"; }
          else if (cvssScore >= 4.0) { cvssColor = "#eab308"; borderColor = "#eab308"; }
          else if (cvssScore > 0) { cvssColor = "#22c55e"; borderColor = "#22c55e"; }

          const backgrounds = ["#1c1c1c", "#202020", "#2a2a2a"];
          const baseColor = backgrounds[resultadosRenderizados % backgrounds.length];

          const card = document.createElement("div");
          card.className = `p-4 rounded-lg shadow hover:shadow-lg transition text-sm border-l-4 relative group`;
          card.style.backgroundColor = baseColor;
          card.style.borderLeft = `4px solid ${borderColor}`;

          const contentWrapper = document.createElement("div");
          contentWrapper.className = "card-content-wrapper overflow-hidden max-h-[100px] transition-all duration-300 ease-in-out";

          const hasPocList = Array.isArray(infoCVE.pocList) && infoCVE.pocList.length > 0;
          const hasAdvisorie = !!infoCVE.github?.pocAdvisorie?.url;
          const hasRepo = !!infoCVE.github?.repo;
          const tags = [];

          if (hasPocList)
            tags.push(`<span class="bg-[#3b3b3b] text-green-400 text-xs px-2 py-0.5 rounded">PoCs: ${infoCVE.pocList.length}</span>`);

          if (hasAdvisorie)
            tags.push(`<span class="bg-[#3b3b3b] text-blue-400 text-xs px-2 py-0.5 rounded">Advisorie</span>`);

          if (hasRepo)
            tags.push(`<span class="bg-[#3b3b3b] text-yellow-300 text-xs px-2 py-0.5 rounded">Repo</span>`);

          if (Array.isArray(infoCVE.github?.commits) && infoCVE.github.commits.length > 0)
            tags.push(`<span class="bg-[#3b3b3b] text-purple-400 text-xs px-2 py-0.5 rounded">Commit</span>`);

          contentWrapper.innerHTML = `
            <div class="flex items-start justify-between mb-2">
              <h2 class="text-lg font-semibold text-[#f0eada]">${infoCVE["cveId"]}</h2>
              <div class="flex flex-wrap gap-1">${tags.join('')}</div>
            </div>
          
            <pre class="whitespace-pre-wrap text-[#d6d3cd] text-base mb-2">${infoCVE["description"]?.[0] || ""}</pre>
          
            <div class="flex flex-wrap gap-2 mb-3">
              <span class="bg-[#2d2a26] text-[#e7e5e4] text-xs px-2 py-1 rounded">CWE: ${infoCVE.cwe || "N/A"}</span>
              <span class="bg-[#2d2a26] text-[${cvssColor}] font-semibold text-xs px-2 py-1 rounded">CVSS Score: ${cvssScore}</span>
              <span class="bg-[#2d2a26] text-[#e7e5e4] text-xs px-2 py-1 rounded">Publicado: ${infoCVE.published}</span>
              ${infoCVE.github?.info?.language ? `
                <span class="bg-[#2d2a26] text-[#38bdf8] text-xs px-2 py-1 rounded flex items-center gap-1">
                  <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/${infoCVE.github.info.language.toLowerCase()}/${infoCVE.github.info.language.toLowerCase()}-original.svg" class="w-4 h-4" />
                  ${infoCVE.github.info.language}
                </span>` : ""
            }
            </div>
          
            ${hasRepo ? `
              <pre class="text-[#a8a29e] text-sm mb-2">üîó Reposit√≥rio: <a href="${infoCVE.github.repo}" class="text-[#60a5fa] hover:underline" target="_blank">${infoCVE.github.repo}</a></pre>` : ""
            }
            
            ${hasAdvisorie ? `
              <pre class="text-[#a8a29e] text-sm mb-2">üîç Advisorie: <a href="${infoCVE.github.pocAdvisorie.url}" class="text-[#60a5fa] hover:underline" target="_blank">${infoCVE.github.pocAdvisorie.url}</a><br/> Kw: <span class="text-[#34d399]">${infoCVE.github.pocAdvisorie.kw}</span></pre>` : ""
            }
            
            ${hasPocList ? `
              <div class="mb-2">
                <p class="text-xs font-semibold text-[#c4bfb5] mb-1">üí• PoCs encontrados:</p>
                <ul class="list-disc ml-4 text-sm text-[#a8a29e]">
                  ${infoCVE.pocList.map(poc => `
                    <li><a href="${poc}" target="_blank" class="text-[#60a5fa] hover:underline">${poc}</a></li>
                  `).join("")}
                </ul>
              </div>` : ""
            }
            
            ${Array.isArray(infoCVE.github?.commits) && infoCVE.github.commits.length > 0 ? `
              <div class="mb-2">
                <p class="text-xs font-semibold text-[#c4bfb5] mb-1">üîß Commits:</p>
                <ul class="list-disc ml-4 text-sm text-[#a8a29e]">
                  ${infoCVE.github.commits.map(commit => `
                    <li><a href="${commit}" target="_blank" class="text-[#60a5fa] hover:underline">${commit.split("/").pop().slice(0, 8)}</a></li>
                  `).join("")}
                </ul>
              </div>` : ""
            }
            
            ${Array.isArray(infoCVE.references) && infoCVE.references.length > 0 ? `
              <div class="mb-2">
                <p class="text-xs font-semibold text-[#c4bfb5] mb-1">üìö Refer√™ncias:</p>
                <ul class="list-disc ml-4 text-sm text-[#a8a29e]">
                  ${infoCVE.references.map(ref => `
                    <li><a href="${ref}" target="_blank" class="text-[#60a5fa] hover:underline">${ref}</a></li>
                  `).join("")}
                </ul>
              </div>` : ""
            }
          `;


          const toggleBtn = document.createElement("button");
          toggleBtn.innerHTML = "‚ñº";
          toggleBtn.className = "absolute bottom-1 right-2 text-[#a8a29e] text-xs bg-[#1c1c1c] px-1 rounded cursor-pointer group-hover:opacity-100 opacity-0 transition-opacity";
          toggleBtn.onclick = () => {
            const isOpen = contentWrapper.classList.contains("max-h-[100px]");
            contentWrapper.classList.toggle("max-h-[100px]");
            contentWrapper.classList.toggle("max-h-[1000px]");
            toggleBtn.innerHTML = isOpen ? "‚ñ≤" : "‚ñº";
          };

          card.appendChild(contentWrapper);
          card.appendChild(toggleBtn);
          resultadoContainer.appendChild(card);
          resultadosRenderizados++;

          if (resultadosRenderizados >= MAX_RESULTADOS) break;
        }
        if (resultadosRenderizados >= MAX_RESULTADOS) break;
      }

      if (resultadosRenderizados === 0) {
        resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-red-400">Nenhum resultado com os filtros selecionados.</div>`;
      }
    }

    async function buscarRepositories(texto, filter = { lang: [] }) {
      resultadoContainer.className = "w-full max-w-6xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"

      resultadoContainer.innerHTML = "";
      //if (!texto.trim()) {
      //  resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-[#c4bfb5]">Digite algo para buscar.</div>`;
      //  return;
      //}

      const encontrados = Object.entries(repositoriesJSON).filter(([chave, valor]) => {
        const contemTexto = chave.toLowerCase().includes(texto.toLowerCase());
        const linguagemAceita = filter.lang.length === 0 || filter.lang.includes(valor.language);
        return contemTexto && linguagemAceita;
      });

      console.log("encontrados:", encontrados)
      if (encontrados.length > 0) {
        const limitados = encontrados.sort(([, a], [, b]) => b.stargazers - a.stargazers).slice(0, MAX_RESULTADOS);
        limitados.forEach(async ([chave, valor], index) => {
          let cvssColor = "#a8a29e"; // default
          let borderColor = "#3f3f46"; // fallback neutro

          // Altern√¢ncia de fundo
          const backgrounds = ["#1c1c1c", "#202020", "#2a2a2a"];
          const baseColor = backgrounds[0];

          const card = document.createElement("div");
          card.className = "bg-[#1c1c1c] rounded-lg p-6 shadow hover:shadow-lg transition flex flex-col items-center justify-between text-center relative";

          card.style.backgroundColor = baseColor;
          card.style.borderLeft = `4px solid ${borderColor}`;

          card.innerHTML = `
              <div class="flex flex-col items-center text-center w-full">
                <!-- Avatar -->
                <div class="mb-3 relative flex flex-col items-center">
                  <img src="${valor.avatar}" alt="Avatar"
                    class="w-20 h-20 rounded-lg object-cover shadow-md" />
                
                  <!-- Estrelas abaixo do avatar -->
                  <div class="mt-2 flex items-center gap-1 text-sm text-[#d6b85a] bg-[#2a2a2a] px-2 py-1 rounded-full font-medium shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4" viewBox="0 0 24 24">
                      <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                    ${formatNumbers(valor.stargazers)}
                  </div>
                </div>
              
                <!-- Nome do reposit√≥rio -->
                <h3 class="text-base font-semibold text-[#f0eada] truncate max-w-full mb-1">
                  <a href="${chave}" target="_blank">${chave.replace("https://github.com/", "").replace(/\/$/, "")}</a>
                </h3>
              
                <!-- Linguagem -->
                <div class="flex items-center gap-2 text-sm text-[#c4bfb5] mb-3">
                  <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/${valor.language?.toLowerCase()}/${valor.language?.toLowerCase()}-original.svg" 
                       alt="${valor.language}" class="w-5 h-5" />
                  <span>${valor.language}</span>
                </div>
              
                <!-- CVE Info -->
                <div class="w-full bg-[#2c2c2c] rounded-md px-3 py-2 text-left text-sm mb-2">
                  <div class="flex justify-between items-center cursor-pointer" onclick="toggleDetails(this.nextElementSibling)">
                    <span class="text-[#f87171] font-semibold">üõ°Ô∏è CVEs:</span>
                    <span class="text-[#f87171] font-bold underline">${repositoriesCVEsJSON[chave]?.listCVEs?.length || 0}</span>
                  </div>
                  <ul class="cve-list hidden mt-2 ml-2 text-xs text-[#e5e5e5] list-disc pl-4">
                    ${(repositoriesCVEsJSON[chave]?.listCVEs || [])
              .map(cve => `<li><a href="/cves/${cve}.json" target="_blank" class="text-[#60a5fa] hover:underline">${cve}</a></li>`)
              .join('')
            }
                  </ul>
                
                  <div class="flex justify-between items-center mt-2 cursor-pointer" onclick="toggleDetails(this.nextElementSibling)">
                    <span class="text-[#60a5fa] font-semibold">üîß Commits de corre√ß√£o:</span>
                    <span class="text-[#60a5fa] font-bold underline">${repositoriesCVEsJSON[chave]?.commitsCVEs?.length || 0}</span>
                  </div>
                  <ul class="commit-list hidden mt-2 ml-2 text-xs text-[#e5e5e5] list-disc pl-4">
                    ${(repositoriesCVEsJSON[chave]?.commitsCVEs || [])
              .map(url => `<li><a href="/cves/${url}.json" target="_blank" class="text-[#60a5fa] hover:underline">${url.split('/').pop().slice(0, 8)}</a></li>`)
              .join('')
            }
                  </ul>
                </div>  

              </div>
            `;


          resultadoContainer.appendChild(card);

        });

        if (encontrados.length > MAX_RESULTADOS) {
          const aviso = document.createElement("div");
          aviso.className = "col-span-full text-center text-yellow-400 text-sm mt-4";
          aviso.textContent = `‚ö†Ô∏è Mostrando apenas os primeiros ${MAX_RESULTADOS} de ${encontrados.length} resultados. Refine sua busca para mais precis√£o.`;
          resultadoContainer.appendChild(aviso);
        }

      } else {
        resultadoContainer.innerHTML = `<div class="col-span-full text-center text-sm text-red-400">Nenhum reposit√≥rio encontrada.</div>`;
      }
    }

    function toggleDetails(ulElement) {
      if (!ulElement) return;
      ulElement.classList.toggle("hidden");
    }

    let debounceTimer;
    document.getElementById("busca").addEventListener("input", (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        if (optionSearch == "CVEs") {
          buscarDescricoes(e.target.value, { cwe: getFiltrosSelecionados("cwe"), score: getFiltrosSelecionados("score"), options: getFiltrosSelecionados("options"), langMain: getFiltrosSelecionados("cve_lang_main") });
        }
        if (optionSearch == "Reposit√≥rios") {
          buscarRepositories(e.target.value, { lang: getFiltrosSelecionados("lang") });
        }
      }, 500);
    });

    carregarJsonComprimido('/index/descriptions.json.gz');
    getRepositories()
    carregarCWEMap()
    carregarScoreMap()
  </script>

</body>

</html>